import GeoJSON from 'ol/format/GeoJSON';
import { Style, Stroke, Fill , Text, Icon } from 'ol/style'; // Added for styling
import React, { useEffect, useRef , useState } from 'react';
import { styled } from '@superset-ui/core';
import {transform} from 'ol/proj.js';
import { FloorPlanProps, FloorPlanStylesProps } from './types';
import Map from 'ol/Map';
import View from 'ol/View';
import TileLayer from 'ol/layer/Tile';
import OSM from 'ol/source/OSM';
import VectorLayer from 'ol/layer/Vector';
import VectorSource from 'ol/source/Vector';
import { Heatmap as HeatmapLayer } from 'ol/layer';
import Point from 'ol/geom/Point';
import Feature from 'ol/Feature';
import { fromLonLat } from 'ol/proj';
import BaseLayer from 'ol/layer/Base';
import { LineString } from 'ol/geom';



const Styles = styled.div<FloorPlanStylesProps>`
  background-color: ${({ theme }) => theme.colors.secondary.light2};
  padding: ${({ theme }) => theme.gridUnit * 4}px;
  border-radius: ${({ theme }) => theme.gridUnit * 2}px;
  height: ${({ height }) => height}px;
  width: ${({ width }) => width}px;

  h3 {
    /* You can use your props to control CSS! */
    margin-top: 0;
    margin-bottom: ${({ theme }) => theme.gridUnit * 3}px;
    font-size: ${({ theme, headerFontSize }) =>
      theme.typography.sizes[headerFontSize]}px;
    font-weight: ${({ theme, boldText }) =>
      theme.typography.weights[boldText ? 'bold' : 'normal']};
  }

  pre {
    height: ${({ theme, headerFontSize, height }) =>
      height - theme.gridUnit * 12 - theme.typography.sizes[headerFontSize]}px;
  }
`;


export default function FloorPlan2(props: FloorPlanProps) {
  const { height, width } = props;
    const mapContainerRef = useRef<HTMLDivElement>(null);
    const [mapInstance, setMapInstance] = useState<Map | null>(null);  // Added state for map

    const userGeoJSON1 = {'type':'FeatureCollection','crs':{'type':'name','properties':{'name':'EPSG:3857',},},'features':[{'type':'Feature','properties':{'stroke':'#555555','stroke-width':3,'stroke-opacity':1},'geometry':{'coordinates':[[-122.3419513740069,47.61439359979039],[-122.34191907659722,47.614417285432836],[-122.34195150841862,47.614435882915046],[-122.34198308590364,47.61441224086934]],'type':'LineString'}},{'type':'Feature','properties':{'stroke':'#555555','stroke-width':6,'stroke-opacity':1},'geometry':{'coordinates':[[-122.34176233353632,47.614635155735556],[-122.34139228955567,47.61442093222334],[-122.34166043410018,47.614211959941514],[-122.34167050889505,47.614218751553324],[-122.34165345924191,47.61423285720713],[-122.34168445861118,47.614249052582664],[-122.34169375842212,47.614240693680046],[-122.34186937758929,47.614337041465404],[-122.34187702299936,47.614330390668016],[-122.34188950519906,47.61433786031074],[-122.34188175535678,47.61434446849975],[-122.34195880302951,47.61438749671399],[-122.34195105318724,47.61439376587418],[-122.3420099519889,47.61442720137879],[-122.342030876563,47.61441361820732],[-122.3420386264055,47.61441884250388],[-122.34176256438039,47.614635466966746]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[[-122.34194285103777,47.61440335355354],[-122.34193432429112,47.61439777924281],[-122.34192243991953,47.61440578810743],[-122.34193148204237,47.61441171243024],[-122.34194285103777,47.61440335355354]]],'type':'Polygon'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34177152279528,47.61462882585471],[-122.34176275886915,47.61462351079743],[-122.34176889553659,47.614619120178986],[-122.3417536101858,47.61461040377441],[-122.34174786100903,47.6146149500091],[-122.34162040087006,47.614542102803796],[-122.34162660074387,47.61453740094737],[-122.3415522022577,47.614496129080436],[-122.34154677736812,47.61449978608246],[-122.3415328276518,47.614490904790784],[-122.34152817774645,47.61449456179318],[-122.34151965291997,47.61448933750407],[-122.34158862651655,47.614431347855486],[-122.3415328276518,47.61440000207236],[-122.34146307907102,47.614455379609666],[-122.34145261678385,47.61444963288369],[-122.34145978538803,47.614444931019165],[-122.34143392028902,47.614429258135075],[-122.34142796259768,47.61443343757313],[-122.3413979803956,47.61441645861166]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.3419343112345,47.61450156689341],[-122.34188757376242,47.61447434286396],[-122.34187396090633,47.61448443716861]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34189820361752,47.61448059212293],[-122.34186028969037,47.614509825549845]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34187714032481,47.61449696284404],[-122.34191307182442,47.61451684156998]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34186028969037,47.61450965850193],[-122.34184856276262,47.61450271622519],[-122.34186549356275,47.61448927862881]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34186021726266,47.61450984554412],[-122.3418706108224,47.614515495913224],[-122.34186977263205,47.61451628696466],[-122.34189575653204,47.614530638899765]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34188394723787,47.61454129590001],[-122.34183563993768,47.61451184911277]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34184848634348,47.614502669299156],[-122.34181250778762,47.61453066283343]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34181265147049,47.614530485201556],[-122.34186026068076,47.61455873703139]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34185363375943,47.61452288153623],[-122.34183025536852,47.61454083724257]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.3417534681856,47.61461064164553],[-122.34183627299244,47.61454433532464]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34177189584514,47.61461048031612],[-122.34179678515102,47.614591604802854]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34181999921553,47.61458966885212],[-122.34179606719033,47.614576439855256]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34183459775076,47.614579021123575],[-122.34181066572559,47.61456514680668]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34182376809954,47.614554109523795],[-122.34169841756157,47.61448341826997],[-122.34162281704295,47.614542930448465]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34180864799083,47.6145452320404],[-122.34181206220795,47.61454293046552],[-122.34172817001944,47.614495912562575],[-122.34172475580232,47.61449788534276]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[[-122.34165354499105,47.614464019275744],[-122.34161550085902,47.614442647474306],[-122.34156965280252,47.61447947272626],[-122.34160672144401,47.61449985812246],[-122.34165354499105,47.614464019275744]]],'type':'Polygon'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34181625278092,47.61452724920517],[-122.34173772579061,47.614484505646004]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34182015474315,47.61452396124011],[-122.34174211549796,47.61448088888142]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34178747580933,47.61450521983656],[-122.34183868906402,47.614464120243866],[-122.34179381649778,47.61443946047251],[-122.3417323605924,47.61448976639363],[-122.34166505174335,47.614452941148926],[-122.34166963469225,47.61444919411525]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.3418279586679,47.61447201136815],[-122.3417835738471,47.61444702280346]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34179364886018,47.61443933723936],[-122.34178963993517,47.6144369431037],[-122.34173278688259,47.61448416662344],[-122.34172281883114,47.61447877241659],[-122.3417182463173,47.61448195760232]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.341697819263,47.614470538031185],[-122.34175863364024,47.61442148107315],[-122.34172241833684,47.61440167402503],[-122.34171729352991,47.61440535905771],[-122.34174940898764,47.61442309327461],[-122.34169884422428,47.61446478017484],[-122.34166912034308,47.61444934911631],[-122.3416240220406,47.614424475161144],[-122.3416747600698,47.61438225751857],[-122.34169491601838,47.614393266995336],[-122.3416989135307,47.614389835636274],[-122.34167370208104,47.61437696247333],[-122.34161503833417,47.614426318772644],[-122.34163597992405,47.614437603083076],[-122.34164092433771,47.6144335833296]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34166940409992,47.61444942114289],[-122.34171990067264,47.614406668770215]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.3417347385282,47.61441489658796],[-122.34173928561317,47.61441086334426]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34178540250862,47.61444031158828],[-122.34175536206575,47.614424162252874]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34170250609694,47.61446158768953],[-122.34167322617185,47.61444595103802]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34172380058807,47.61444390032929],[-122.34169452066274,47.61442800733337]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34169452066274,47.614392632584156],[-122.34164470676404,47.61443544115451]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34165079090428,47.61443005804273],[-122.34163072715464,47.61441869645665]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.3416686630664,47.614414677720276],[-122.34164888961058,47.61440391149259]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34160584269685,47.6144214031749],[-122.3416000692477,47.61441834086028],[-122.34165617990762,47.61436928917044],[-122.34166573135951,47.61437418993401],[-122.34166255434081,47.614377243964526],[-122.3416554643723,47.61437373790318],[-122.3416068116473,47.61441718046066],[-122.34160896244023,47.61441881775019],[-122.3416058426964,47.61442126813]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34166384913811,47.61437540824343],[-122.34167105757473,47.61437936351234]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34162898042122,47.61441462189498],[-122.34161691048031,47.61440784143886]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34163099207774,47.614412813773384],[-122.34161925741311,47.61440592030948]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34158874728593,47.614431347016904],[-122.34160132014051,47.614419142198955]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34164346073047,47.61438024846183],[-122.34162065566427,47.614367570464964],[-122.34161699269146,47.61437049176831]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34153281789479,47.61440019170962],[-122.34157835292724,47.614362187212635],[-122.34154013602486,47.614341540526794],[-122.34152929435058,47.61435067622946],[-122.34156859542034,47.614370592055565]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34165587089907,47.61436949577188],[-122.34160383086204,47.61434336766763],[-122.3415797081366,47.61436310078264],[-122.34157808188527,47.614362187212635]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34160416678795,47.61434356715287],[-122.34156832502812,47.614323634419804],[-122.34154420230233,47.61434373297004]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34155579404973,47.6143344981686],[-122.3415238034073,47.61431825022024]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34148547769655,47.61443754804188],[-122.34141886561198,47.61439988636485]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.3415038957842,47.614423062784454],[-122.34149069615484,47.614416440951345],[-122.34147319897107,47.61443030541341]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34142960949674,47.61440568047044],[-122.34143759066826,47.614399058635684],[-122.34142776768779,47.6143932645283]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34143114433749,47.61439160906963],[-122.34144894848909,47.61440174875588],[-122.34146245508671,47.61439078133978],[-122.34144403699904,47.61438105551588]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34169867887618,47.61424384056036],[-122.34159394238885,47.61433807872635]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34166599588097,47.61427336674214],[-122.34161441622709,47.6142470895702]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34182970303736,47.614420724313845],[-122.3418144177796,47.61443338484294],[-122.34160881228115,47.61432354143429]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34161443092191,47.61436667899878],[-122.34160252861936,47.61436035056687]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34160906650393,47.61436374079844],[-122.34159749947761,47.614373572467855]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34182261653403,47.61442639310272],[-122.34185880259314,47.61444628047079]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34185328077218,47.61445103748002],[-122.34186340711493,47.61444250213498]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34183260161451,47.61442203418875],[-122.3418236993566,47.61441708128939],[-122.34183434853817,47.61440819255694]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34183963512315,47.61441110524541],[-122.34179948599413,47.61438945308424],[-122.34179652763714,47.61439215960482],[-122.34174117685598,47.61436255637386]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34171804888703,47.61438207884515],[-122.3417438954742,47.61435997665092],[-122.34169938190746,47.61433739045742],[-122.34167521056227,47.61435884734132]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34171723212714,47.614333524587494],[-122.34172292400623,47.61432895673508],[-122.34182612824623,47.614383416048895]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[[-122.34184538166832,47.6143503135203],[-122.3418458939876,47.61435029655369],[-122.34184640137298,47.614350245817235],[-122.34184689893803,47.61435016179957],[-122.34184738189096,47.614350045309834],[-122.34184784558065,47.614349897469886],[-122.34184828554147,47.61434971970351],[-122.34184869753643,47.61434951372268],[-122.34184907759779,47.614349281511096],[-122.3418494220653,47.6143490253051],[-122.34184972762155,47.61434874757211],[-122.34184999132391,47.61434845098682],[-122.34185021063276,47.61434813840552],[-122.34185038343603,47.61434781283853],[-122.34185050806954,47.61434747742125],[-122.34185058333303,47.61434713538394],[-122.34185060850163,47.614346790020576],[-122.34185058333297,47.61434644465723],[-122.34185050806943,47.61434610261991],[-122.34185038343584,47.61434576720264],[-122.3418502106325,47.614345441635685],[-122.34184999132361,47.6143451290544],[-122.34184972762122,47.61434483246912],[-122.34184942206494,47.61434455473614],[-122.34184907759742,47.614344298530185],[-122.34184869753611,47.61434406631863],[-122.34184828554115,47.61434386033782],[-122.34184784558033,47.61434368257146],[-122.34184738189069,47.614343534731525],[-122.34184689893783,47.6143434182418],[-122.34184640137285,47.61434333422415],[-122.34184589398753,47.61434328348771],[-122.34184538166832,47.6143432665211],[-122.34184486934909,47.61434328348771],[-122.34184436196377,47.61434333422415],[-122.34184386439878,47.6143434182418],[-122.34184338144593,47.614343534731525],[-122.34184291775628,47.61434368257146],[-122.34184247779548,47.61434386033782],[-122.34184206580052,47.61434406631863],[-122.3418416857392,47.614344298530185],[-122.34184134127169,47.61434455473614],[-122.34184103571539,47.61434483246912],[-122.341840772013,47.6143451290544],[-122.34184055270411,47.614345441635685],[-122.34184037990077,47.61434576720264],[-122.3418402552672,47.61434610261991],[-122.34184018000364,47.61434644465723],[-122.341840154835,47.614346790020576],[-122.34184018000359,47.61434713538394],[-122.34184025526707,47.61434747742125],[-122.34184037990059,47.61434781283853],[-122.34184055270387,47.61434813840552],[-122.3418407720127,47.61434845098682],[-122.34184103571506,47.61434874757211],[-122.34184134127133,47.6143490253051],[-122.34184168573883,47.614349281511096],[-122.34184206580018,47.61434951372268],[-122.34184247779514,47.61434971970351],[-122.34184291775598,47.614349897469886],[-122.34184338144567,47.614350045309834],[-122.34184386439858,47.61435016179957],[-122.34184436196365,47.614350245817235],[-122.34184486934902,47.61435029655369],[-122.34184538166832,47.6143503135203]]],'type':'Polygon'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[[-122.34175037165136,47.61430430815101],[-122.34175098559261,47.61430428781894],[-122.34175159362127,47.61430422701852],[-122.34175218988172,47.61430412633531],[-122.34175276863157,47.614303986738925],[-122.34175332429723,47.61430380957378],[-122.34175385152727,47.61430359654604],[-122.34175434524418,47.6143033497073],[-122.34175480069322,47.614303071434755],[-122.34175521348818,47.61430276440832],[-122.34175557965358,47.61430243158481],[-122.34175589566307,47.61430207616952],[-122.34175615847329,47.6143017015853],[-122.34175636555325,47.61430131143956],[-122.34175651490867,47.61430090948965],[-122.34175660510112,47.61430049960658],[-122.3417566352621,47.61430008573772],[-122.34175660510105,47.61429967186885],[-122.34175651490847,47.6142992619858],[-122.34175636555298,47.61429886003591],[-122.34175615847293,47.61429846989019],[-122.34175589566264,47.61429809530598],[-122.3417555796531,47.61429773989074],[-122.34175521348767,47.614297407067255],[-122.34175480069273,47.614297100040844],[-122.3417543452437,47.614296821768335],[-122.34175385152678,47.61429657492963],[-122.34175332429679,47.61429636190192],[-122.34175276863122,47.61429618473681],[-122.34175218988143,47.614296045140435],[-122.34175159362108,47.61429594445723],[-122.34175098559253,47.61429588365684],[-122.34175037165136,47.61429586332476],[-122.34174975771018,47.61429588365684],[-122.34174914968159,47.61429594445723],[-122.34174855342125,47.614296045140435],[-122.34174797467148,47.61429618473681],[-122.3417474190059,47.61429636190192],[-122.34174689177591,47.61429657492963],[-122.34174639805899,47.614296821768335],[-122.34174594260999,47.614297100040844],[-122.34174552981503,47.614297407067255],[-122.34174516364959,47.61429773989074],[-122.34174484764006,47.61429809530598],[-122.34174458482975,47.61429846989019],[-122.34174437774972,47.61429886003591],[-122.34174422839423,47.6142992619858],[-122.34174413820163,47.61429967186885],[-122.34174410804059,47.61430008573772],[-122.34174413820156,47.61430049960658],[-122.34174422839403,47.61430090948965],[-122.34174437774944,47.61430131143956],[-122.3417445848294,47.6143017015853],[-122.34174484763963,47.61430207616952],[-122.3417451636491,47.61430243158481],[-122.3417455298145,47.61430276440832],[-122.34174594260946,47.614303071434755],[-122.3417463980585,47.6143033497073],[-122.34174689177544,47.61430359654604],[-122.34174741900547,47.61430380957378],[-122.34174797467112,47.614303986738925],[-122.34174855342098,47.61430412633531],[-122.34174914968143,47.61430422701852],[-122.34174975771008,47.61430428781894],[-122.34175037165136,47.61430430815101]]],'type':'Polygon'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[[-122.34195963867641,47.61442980890149],[-122.34195240055686,47.614426061070986],[-122.34193926966235,47.61443457237024],[-122.34194667117967,47.61443945456318],[-122.34195963867641,47.61442980890149]]],'type':'Polygon'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[[-122.34189035905504,47.6145041128797],[-122.34189387945437,47.61450128769434],[-122.34188113896145,47.61449360318974],[-122.34187745092419,47.614496993412644],[-122.34189035905504,47.6145041128797]]],'type':'Polygon'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[[-122.3418285221826,47.61454200559575],[-122.34183187494364,47.61453940642747],[-122.34182449886909,47.614534886134436],[-122.34182081083144,47.61453703327348],[-122.3418285221826,47.61454200559575]]],'type':'Polygon'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[[-122.34176274894915,47.614604544872805],[-122.34177204664215,47.614596852687356],[-122.34176845435161,47.61459443107293],[-122.34175894534734,47.61460212325909],[-122.34176274894915,47.614604544872805]]],'type':'Polygon'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[[-122.34164061121726,47.614531184361766],[-122.34165307857853,47.61452149789227],[-122.34164906366544,47.61451936117069],[-122.34163617368188,47.61452847784841],[-122.34164061121726,47.614531184361766]]],'type':'Polygon'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[[-122.34154148492138,47.614470576401004],[-122.34153345509543,47.614477271467365],[-122.34153831525337,47.61448040532835],[-122.34154697901283,47.61447371026202],[-122.34154148492138,47.614470576401004]]],'type':'Polygon'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[[-122.34147701915697,47.614432551891326],[-122.3414789209576,47.614430984959625],[-122.34147490604478,47.61442899068288],[-122.34147321555514,47.614430130269625],[-122.34147701915697,47.614432551891326]]],'type':'Polygon'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[[-122.34153854253015,47.614396810946175],[-122.3415501646466,47.61438683955481],[-122.34154551579994,47.614384417930665],[-122.34153347106124,47.614393819528885],[-122.34153854253015,47.614396810946175]]],'type':'Polygon'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[[-122.34159651421494,47.61433888625413],[-122.34159144274605,47.61433646462814],[-122.34158404685367,47.61434273236597],[-122.34158848438905,47.61434529644049],[-122.34159651421494,47.61433888625413]]],'type':'Polygon'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[[-122.34166579113108,47.61427345201008],[-122.3416746662018,47.614265474878266],[-122.34166988633574,47.61426263541378],[-122.34166093097318,47.61427060303441],[-122.34166579113108,47.61427345201008]]],'type':'Polygon'}},{'type':'Feature','properties':{'stroke':'#ff0000','stroke-width':5,'stroke-opacity':1},'geometry':{'coordinates':[[-122.3419477301421,47.614381214510814],[-122.34183910023299,47.614463480519845],[-122.34178987008238,47.61443652595182],[-122.34178570978818,47.61443979789436],[-122.34175612547241,47.614424217213696],[-122.34175936125706,47.614420945270155],[-122.34159494896647,47.614338431677794],[-122.3415921509106,47.61433656822024],[-122.34169884033389,47.61424378703012],[-122.3418692861371,47.614337956771095],[-122.3418778274823,47.61433242921484],[-122.34188807709619,47.614337726455915],[-122.34187919409752,47.61434440558571],[-122.34194752471703,47.614382177244806]],'type':'LineString'},'id':71},{'type':'Feature','properties':{'stroke':'#ff0000','stroke-width':5,'stroke-opacity':1},'geometry':{'coordinates':[[-122.34194872074076,47.61438276396535],[-122.34178873262465,47.61450526477091],[-122.34182202494944,47.614524590571506],[-122.34181370186802,47.6145305129927],[-122.34182156255588,47.614534876881834],[-122.34182250427813,47.614535465489496],[-122.34182434829674,47.61453422240885],[-122.34183273019994,47.614539307739165],[-122.34183122145754,47.61454088984141],[-122.34185988756651,47.61455806695221],[-122.34203741803557,47.614418950845106],[-122.34203104778932,47.6144143175336],[-122.34201026066943,47.614427878443934],[-122.34195007860458,47.614393976161836],[-122.3419571194033,47.61438753472564],[-122.34194856986218,47.61438244938108]],'type':'LineString'},'id':72}]};
    const userGeoJSON2 = {'type':'FeatureCollection','crs':{'type':'name','properties':{'name':'EPSG:3857',},},'features':[{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34163305795829,47.61443628039058],[-122.34163708127178,47.6144328901637],[-122.34162542629937,47.614426735880244],[-122.34169470241469,47.61436648560246],[-122.34171030655084,47.61437477590937],[-122.34171448343321,47.61437080832093]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34185819580298,47.61445058169974],[-122.34177522841823,47.61440223693816],[-122.34169712540314,47.61446845957536],[-122.34178201338216,47.61451167681665],[-122.34179564290241,47.614500983690874],[-122.34178748033808,47.61449646318849],[-122.34184353543922,47.61445217350473],[-122.34184996961629,47.61445623944806],[-122.34185773476015,47.614450324925514]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34200468717125,47.61438628016188],[-122.34189365508426,47.61446939121649],[-122.34194124026445,47.61449563678542]],'type':'LineString'}},{'type':'Feature','properties':{'stroke':'#555555','stroke-width':5,'stroke-opacity':1},'geometry':{'coordinates':[[-122.34139202627935,47.61442192717581],[-122.34148785470951,47.614346510534205],[-122.34149580269357,47.614350832559865],[-122.34148546235333,47.61435880486147],[-122.34154130407487,47.614389529983924],[-122.34162065998517,47.6143239488365],[-122.34156627724205,47.61429450880766],[-122.34155934047863,47.61430064768351],[-122.34155179293533,47.614296733128356],[-122.34166586461585,47.61420798096091],[-122.34171301335404,47.614235287334395],[-122.34172482852983,47.614225089266284],[-122.34177780661656,47.61425490869496],[-122.34185005862187,47.61428768098787],[-122.34184586724422,47.61429457442992],[-122.34204831422942,47.614412202004786],[-122.3417621345832,47.614635657907826],[-122.34157864904917,47.614528096448126],[-122.3413927077701,47.61442136271614]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34161668103606,47.61432217097436],[-122.3417210916288,47.61424032291258],[-122.34171297555395,47.614235184760844]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34159014715652,47.614307683275825],[-122.34162751090068,47.61427595090939],[-122.34159854437706,47.61426031186201]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34151064536606,47.61437238293328],[-122.34147341535078,47.614402300504366],[-122.34143970629037,47.61438438936443]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34177182189953,47.61425197499938],[-122.34167547393798,47.614328402005754],[-122.34165457919929,47.61431666407691],[-122.34168282579054,47.6142950141126],[-122.341703720529,47.61430675204565]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.3416565138974,47.614315099019706],[-122.34163871467553,47.61430466530274]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34167532151265,47.61432844987331],[-122.34169529866995,47.61433940299608],[-122.34172246760369,47.61431803542686],[-122.3417032895326,47.614306543621694]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34154140771096,47.61439016682209],[-122.34159260733998,47.614418685899636],[-122.34167598283753,47.61434907178463],[-122.34165309891209,47.61433687414106],[-122.34164908880413,47.61434023850015],[-122.34161927057033,47.614324250336296]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34155568530488,47.61437784420619],[-122.34160785879773,47.614405800667726]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34165405423765,47.61433732395017],[-122.34162155131068,47.61436419075059]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34164350354112,47.61437630251871],[-122.34160491290768,47.61435506125633],[-122.34161241806297,47.614349428543676]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34184895385434,47.61429636454446],[-122.34175594645686,47.61436829705076]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.3419196106373,47.61448348606058],[-122.34195421804074,47.61445626842735],[-122.34197801063085,47.61446793312908]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.3419095168113,47.61445724048562],[-122.34188820193974,47.61444466527712],[-122.34191746601839,47.61442282965572],[-122.34193916944,47.61443494524562]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34187424382259,47.614433880593],[-122.34196440978268,47.61436327747009]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34189090681389,47.61444267661781],[-122.34186006141005,47.61442606450697]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34189384375003,47.614469356324804],[-122.34187305663013,47.61445715151572],[-122.34186501000359,47.614462236853],[-122.34186752457424,47.614463705950726],[-122.3418651776415,47.61446494903308],[-122.34189585540699,47.614480996094244],[-122.34189300555967,47.61448291722084],[-122.34193122703843,47.61450325855802]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34190519814283,47.6145230228517],[-122.34187634381519,47.614506184548134],[-122.34190017470905,47.61448674899205]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34186552562623,47.614465410430796],[-122.34179716206108,47.614518880783095],[-122.34182294794266,47.614533099269124],[-122.34180918441984,47.61454279920204],[-122.34185297744611,47.61456599468724]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34180737969723,47.61451084424888],[-122.341833658025,47.61452559883659],[-122.34182306643706,47.614533417101256]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34179727946979,47.614518836354904],[-122.34179321949944,47.6145157285014],[-122.34180781563457,47.61450419632166],[-122.34181276118146,47.614506805436804]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34180939806764,47.61454288771077],[-122.34178717263512,47.614529732346966],[-122.34177578887693,47.61453850258988],[-122.34177280741659,47.614537223596045],[-122.34175654490477,47.61454946539166],[-122.34182430537007,47.61458692161304]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34173189697147,47.614486452810695],[-122.34180917811894,47.61442132112478]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34170146167182,47.6144659068257],[-122.34173099257227,47.614481585683194],[-122.34180096009561,47.61442206501181],[-122.34177170992312,47.61440491194705]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34174348213061,47.61449261068003],[-122.34174733404751,47.61448940964732],[-122.34175627349225,47.61449362521378],[-122.34182774569182,47.614433055730245]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34175605122726,47.61449939112521],[-122.34183165975203,47.61443535523961]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34184411207895,47.614452414310506],[-122.34182529326338,47.61444168366242]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.3418205956402,47.61444416729435],[-122.34181656856798,47.61444160241294]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34178928691568,47.61449543079874],[-122.34177248351546,47.61448586705862]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34180917746029,47.61447866887303],[-122.34179276772122,47.61446891847274]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34181387884253,47.6144756519619],[-122.34179629187894,47.6144659409195]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34180098198654,47.61445606990935],[-122.3417812044529,47.614445486560356]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34180349279919,47.61445365992648],[-122.34178394128891,47.614442698196655]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34167612630745,47.61445881533166],[-122.34161107437923,47.61442576839988],[-122.34169064264702,47.614357945329914],[-122.34175655799788,47.61439209560493],[-122.34174947071726,47.61439932069567],[-122.34174671455241,47.614397462719154]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34174666410044,47.614397675545916],[-122.34174919699976,47.61439562905332],[-122.34167595310842,47.61445870588804]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34175224860121,47.61439695376731],[-122.34173615534682,47.6143880261632],[-122.34173313786202,47.61438633104825],[-122.34166038294217,47.614447129133964],[-122.34167899076724,47.61445639575018]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.3416540127161,47.61444735512973],[-122.34173280260597,47.614380454630435]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.3417042371222,47.61446226132887],[-122.34168402098436,47.614451757073454]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34166973514724,47.614455520632504],[-122.34167224971831,47.614453147474734]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.3416917305673,47.61444550699693],[-122.34167331247966,47.61443598811576]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34167116370246,47.61443247026756],[-122.34163788358873,47.61441472760649]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34167546125644,47.61442895241967],[-122.3416426950503,47.61441100282423]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34167227778332,47.614409977441255],[-122.34169714220143,47.61438921677336]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34171292019454,47.614455427965936],[-122.34174292411537,47.61447210075772]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34176934969277,47.614448959843486],[-122.3417405210076,47.61443226930203]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.3417184367652,47.61442191671921],[-122.34170124655007,47.614412811698514]],'type':'LineString'}},{'type':'Feature','properties':{},'geometry':{'coordinates':[[-122.34176386804849,47.614477788405],[-122.34178259310437,47.6144616477018]],'type':'LineString'}}]};

      const userSource1 = new VectorSource({
        features: new GeoJSON().readFeatures(userGeoJSON1, {
          featureProjection: 'EPSG:3857',
          dataProjection: "EPSG:4326"
        }),
      });

      const userSource2 = new VectorSource({
        features: new GeoJSON().readFeatures(userGeoJSON2, {
          featureProjection: 'EPSG:3857',
          dataProjection: "EPSG:4326"
        }),
      });

      const firstFloorStyle = new Style({
        stroke: new Stroke({
          color: '#ff0000',  // Red color for the first floor
          width: 1,
        }),
      });

      const secondFloorStyle = new Style({
        stroke: new Stroke({
          color: '#0000ff',  // Blue color for the second floor
          width: 1,
        }),
      });

      const userLayer1 = new VectorLayer({
        source: userSource1,
        style: firstFloorStyle,
      });

      const userLayer2 = new VectorLayer({
        source: userSource2,
        style: secondFloorStyle,
      });
      
      
	  const p1 = new Feature({
	  geometry: new Point(fromLonLat([-122.34192070086164, 47.61448103221261])),
	  name: 'First Floor Lobby',
	});


		const p2 = new Feature({
	      geometry: new Point(fromLonLat([-122.34168980785849, 47.61431931912628])),
	      name: 'First Floor Restaraunt/Bar',
	    });
	    
	    
	    const p3 = new Feature({
	  geometry: new Point(fromLonLat([-122.34159760058762, 47.61451034265562])),
	  name: 'Second Floor North',
	});


		const p4 = new Feature({
	      geometry: new Point(fromLonLat([-122.34184348664299, 47.61433751187323])),
	      name: 'Second Floor South',
	    });
	    
	    
    
	const iconStyle = new Style({
      image: new Icon({
        anchor: [0.5, 46],
        anchorXUnits: 'fraction',
        anchorYUnits: 'pixels',
        src: 'https://www.geocodezip.net/mapIcons/google-maps-gps-icon-14.jpg',
        scale: 0.1,
      }),
    });

    const labelStyle = new Style({
      text: new Text({
        font: '12px Calibri,sans-serif',
        overflow: true,
        fill: new Fill({
          color: '#000',
        }),
        stroke: new Stroke({
          color: '#fff',
          width: 3,
        }),
        offsetY: -12,
      }),
    });
    
	var style = [iconStyle, labelStyle];    
	const pointLayer = new VectorLayer({
      source: new VectorSource({
        features: [p1, p2, p3, p4],
      }),
      style: function (feature) {
        labelStyle.getText().setText(feature.get('name'));
        return style;
      },
    });
      

  useEffect(() => {
  
    let floor: string[] = [];
    let latitudes: number[] = [];
    let longitudes: number[] = [];
    let imsi_values: number[] = [];


	let vectorSource: VectorSource<Point> = new VectorSource<Point>();

	props.data.forEach((item, index) => {
	    if (typeof item.Long === 'number' && typeof item.Lat === 'number') {  // Check if Long and Lat are numbers
		let pointFeature = new Feature({
		    geometry: new Point(fromLonLat([item.Long, item.Lat]))
		});
		pointFeature.set('weight', item["SUM(IMSI_Number)"]);
		vectorSource.addFeature(pointFeature);
		latitudes.push(item.Lat);
        longitudes.push(item.Long);
        if (typeof item["SUM(IMSI_Number)"] === 'number') {
        imsi_values.push(item["SUM(IMSI_Number)"]);
        }
        if (typeof item.Floor === 'string') {
            floor.push(item.Floor); // Add item.Floor to the floor array
        }}});
    
    console.log("First and Second Floor" , floor);
    console.log("latitudes for poly line" , latitudes);
    console.log("longitudes for poly line" , longitudes);
    console.log("imsi_values for poly line" , imsi_values);

	let heatmapLayer = new HeatmapLayer({
	    source: vectorSource,
	    gradient: ['#800080', '#800080', '#800080', '#800080', '#c0c0ff', '#ff0', '#f00'],
	    blur: 25,
	    radius: 10,
	    weight: function(feature: Feature) {
		let weight = feature.get('weight');
		return 10 + Math.log(weight);
	    }});

    let imsiMapping: { [key: number]: [number, number][] } = {};

    // Creating mapping from IMSI to coordinates
    for (let i = 0; i < imsi_values.length; i++) {
        if (!imsiMapping[imsi_values[i]]) {
            imsiMapping[imsi_values[i]] = [];
        }
        imsiMapping[imsi_values[i]].push(fromLonLat([longitudes[i], latitudes[i]]) as [number, number]);
    }

        // Setup vector source for lines
        let lineVectorSource: VectorSource<LineString> = new VectorSource<LineString>();

        // Draw lines using the mapping
        for (let imsi in imsiMapping) {
            if (imsiMapping.hasOwnProperty(imsi) && imsiMapping[imsi].length > 1) {
                var lineFeature = new Feature(new LineString(imsiMapping[imsi]));
                lineVectorSource.addFeature(lineFeature);
            }
        }

        // Add the line layer to the map
        const lineVectorLayer = new VectorLayer({
            source: lineVectorSource
        });


    if (mapContainerRef.current) {

      if (mapInstance) {
        mapInstance.dispose();
        setMapInstance(null);
      }

      const layersArray: BaseLayer[] = [
      new TileLayer({
        source: new OSM(),
      }),pointLayer];

        if (floor.includes('Second Floor') && floor.includes('First Floor')) {
	    console.log("I am in both floors");
	    layersArray.push(userLayer1);  // Add the first floor layer
	    layersArray.push(userLayer2);  // Add the second floor layer

	} else if (floor.includes('Second Floor')) {
	    console.log("I am in floor2");
	    layersArray.push(userLayer2);  // Add the second floor layer

	} else if (floor.includes('First Floor')) {
	    console.log("I am in floor1");
	    layersArray.push(userLayer1);  // Add the first floor layer

	} else {
	    console.log("Default: I am in both floors");
	    layersArray.push(userLayer1);  // Add the first floor layer
	    layersArray.push(userLayer2);  // Add the second floor layer

	}

        if (props.heatmap) {
          layersArray.push(heatmapLayer);
        }

        if (props.contours) {
        layersArray.push(lineVectorLayer);
        }

        const map = new Map({
          target: mapContainerRef.current,
          layers: layersArray,
          view: new View({
            center: transform([-122.34172356098475, 47.61442162688107], 'EPSG:4326', 'EPSG:3857'),
            zoom: 19,
          }),});

      setMapInstance(map);

      userSource1.on('change', function (event) {
        if (userSource1.getState() === 'ready') {
          const extent = userSource1.getExtent();
          map.getView().fit(extent, { padding: [10, 10, 10, 10], maxZoom: 19 });
        }
      });
    }
  }, [mapContainerRef, props.floor_selector, props.data]);

  return (
    <Styles
      boldText={props.boldText}
      headerFontSize={props.headerFontSize}
      height={height}
      width={width}>
      <div ref={mapContainerRef} style={{ width: '100%', height: '700px' }}></div>
    </Styles>
  );
}
